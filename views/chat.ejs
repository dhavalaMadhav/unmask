<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #000000;
      --accent: #0066FF;
      --bg: #fff;
      --bg-alt: #F8F8F8;
      --text: #000;
      --text-muted: #666;
      --border: #E0E0E0;
      --my-message: #0066FF;
      --other-message: #F0F0F0;
    }
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg); color: var(--text);
      line-height: 1.6; overflow: hidden;
    }
    .chat-container { display: flex; flex-direction: column; height: 100vh; padding-top: 70px; }
/* Update the header styles */
.header {
  position: fixed; 
  top: 0; 
  left: 0; 
  right: 0;
  background: rgba(255, 255, 255, 0.95); 
  z-index: 1000;
  border-bottom: 1px solid rgba(0,0,0,0.1); 
  backdrop-filter: blur(10px);
  padding: 1.5rem 2rem; 
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  flex-direction: row; /* Ensure horizontal layout */
}

.header h1 {
  font-size: 1.5rem; 
  text-transform: uppercase;
  font-weight: 700; 
  letter-spacing: -0.01em;
  margin: 0; /* Remove any default margins */
}

.header-actions {
  display: flex; 
  gap: 1rem; 
  align-items: center;
  margin-left: auto; /* This pushes the buttons to the right */
}
.encryption-status {
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  padding: 4px 8px;
  margin-left: 1rem;
  letter-spacing: 0.05em;
  transition: all 0.25s ease;
  border: 1px solid black;
}

.encryption-on {
  background: rgba(0, 200, 0, 0.15);
  color: #008800;
}

.encryption-off {
  background: rgba(255, 165, 0, 0.2);
  color: #CC6600;
}

/* Keep the rest of your existing header styles */
.btn-back, .btn-settings {
  padding: 0.75rem 1.5rem; 
  background: transparent; 
  border: 2px solid var(--primary);
  color: var(--primary); 
  font-weight: 600; 
  text-transform: uppercase; 
  font-size: 0.75rem;
  letter-spacing: 0.05em; 
  cursor: pointer; 
  transition: all 0.2s; 
  text-decoration: none;
  display: inline-flex; 
  align-items: center; 
  gap: 0.5rem;
}

.btn-back:hover, .btn-settings:hover { 
  background: var(--primary); 
  color: #fff; 
}

.btn-back svg, .btn-settings svg { 
  width: 16px; 
  height: 16px; 
}

/* Update mobile styles if needed */
@media (max-width: 968px) {
  .media-grid {
    max-height: 250px; /* Slightly smaller on mobile */
  }

  .files-list, .audio-list {
    max-height: 250px; /* Slightly smaller on mobile */
  }

  .settings-sections {
    max-height: 60vh; /* Limit height for mobile */
  }

    .settings-tabs {
    display: flex;
    gap: 0;
    border-bottom: 2px solid var(--border);
    margin-bottom: 1.5rem;
    background: var(--bg);
    position: sticky;
    top: 0;
    z-index: 10;
    overflow-x: auto; /* Enable horizontal scrolling */
    overflow-y: hidden;
    white-space: nowrap;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    scrollbar-width: none; /* Hide scrollbar for Firefox */
    -ms-overflow-style: none; /* Hide scrollbar for IE/Edge */
  }

  .settings-tabs::-webkit-scrollbar {
    display: none; /* Hide scrollbar for Chrome/Safari */
  }

  .settings-tab {
    padding: 1rem 1.2rem;
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 0.8rem; /* Slightly smaller font on mobile */
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
    color: var(--text-muted);
    position: relative;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0; /* Prevent tabs from shrinking */
  }

  .settings-modal {
    max-width: 95%; /* Slightly wider on mobile */
    width: 95%;
    max-height: 85vh; /* Slightly taller on mobile */
  }

  .settings-sections {
    padding-right: 0; /* Remove right padding on mobile */
  }
  
  .header { 
    padding: 1.5rem; 
    flex-direction: row; /* Ensure horizontal layout on mobile too */
    justify-content: space-between;
  }
      .header h1 {
        font-size: 1.5rem;
        width: 100%;
      }  
      
  .header-actions {
    gap: 0.5rem; /* Reduce gap on mobile */
  }
}

@media (max-width: 480px) {
  .header h1 { 
    font-size: 1rem;
  }
  
  .btn-back, .btn-settings { 
    padding: 0.5rem 1rem; 
    font-size: 0.7rem;
  }
}    .chat-body { display: flex; flex: 1; overflow: hidden; }
    .messages-section { flex: 1; display: flex; flex-direction: column; border-right: 2px solid var(--border); min-height: 0; }
    .messages-container { flex: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 0.5rem; min-height: 0; }
    .message-group { display: flex; flex-direction: column; margin-bottom: 1rem; }
    .message-group.my-messages { align-items: flex-end; }
    .message-group.other-messages { align-items: flex-start; }
    .message-author { font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; padding: 0 1rem; }
    .message { max-width: 70vw; margin-bottom: 0.3rem; position: relative; display: flex; align-items: flex-start; gap: 0.5rem; transition: padding-left 0.4s cubic-bezier(0.4,0,0.2,1); }
/* Remove cursor pointer from checkbox */
.message-checkbox {
  display: none;
  width: 20px;
  height: 20px;
  min-width: 20px;
  min-height: 20px;
  cursor: default; /* Changed from pointer to default */
  accent-color: var(--accent);
  opacity: 0;
  transform: translateX(-10px) scale(0.7);
  transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
              transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  flex-shrink: 0;
  margin-top: 0.5rem;
}

/* Add pointer cursor only to message content */
.message-content {
  padding: 1rem 1.5rem; 
  border-radius: 12px; 
  word-wrap: break-word; 
  word-break: break-word; 
  overflow-wrap: break-word;
  font-size: 0.95rem; 
  line-height: 1.6; 
  position: relative; 
  flex: 1; 
  max-width: 80vw; 
  min-width: 0;
  cursor: pointer;
  /* Add subtle shadow */
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.405);
}

.my-messages .message-content { 
  background: var(--my-message); 
  color: #fff; 
  border-bottom-right-radius: 4px; 
  /* Slightly darker shadow for my messages */
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.405);
}

.other-messages .message-content { 
  background: var(--other-message); 
  color: var(--text); 
  border-bottom-left-radius: 4px; 
  /* Lighter shadow for other messages */
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.405);
}

/* Disable hover effects and dropdown in delete mode */
.delete-mode-active .message:hover .message-content::before {
  opacity: 0 !important;
}

.delete-mode-active .message-content {
  cursor: default !important;
  pointer-events: none;
}

.delete-mode-active .message-checkbox {
  pointer-events: all;
  cursor: pointer;
}

/* Hide the menu button (arrow) completely in delete mode */
.delete-mode-active .message-menu-btn {
  display: none !important;
  pointer-events: none !important;
}

/* Hide dropdown in delete mode */
.delete-mode-active .message-dropdown {
  display: none !important;
}

/* Ensure messages don't show hover effects in delete mode */
.delete-mode-active .message {
  cursor: default;
}

.delete-mode-active .message:hover {
  background: transparent;
}


    .delete-mode-active .my-messages .message-checkbox { display: block; opacity: 1; transform: translateX(0) scale(1);}
    .delete-mode-active .my-messages .message:nth-child(2) .message-checkbox { transition-delay: 0.05s; }
    .delete-mode-active .my-messages .message:nth-child(3) .message-checkbox { transition-delay: 0.1s; }
    .delete-mode-active .my-messages .message:nth-child(4) .message-checkbox { transition-delay: 0.15s; }
    .delete-mode-active .my-messages .message:nth-child(5) .message-checkbox { transition-delay: 0.2s; }
    .delete-mode-active .my-messages .message:nth-child(n+6) .message-checkbox { transition-delay: 0.25s; }
    .delete-mode-active .my-messages .message { padding-left: 0.5rem; }
    .my-messages .message { flex-direction: row-reverse; }
    .message-content {
      padding: 1rem 1.5rem; border-radius: 12px; word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;
      font-size: 0.95rem; line-height: 1.6; position: relative; flex: 1; max-width: 80vw; min-width: 0;
    }
    .my-messages .message-content { background: var(--my-message); color: #fff; border-bottom-right-radius: 4px; }
    .other-messages .message-content { background: var(--other-message); color: var(--text); border-bottom-left-radius: 4px; }
    .my-messages .message-content::before, .other-messages .message-content::before {
      content: ''; position: absolute; top: 0; right: 0; width: 60px; height: 40px;
      background: linear-gradient(135deg, rgba(0,0,0,0.1) 0%, transparent 60%);
      border-top-right-radius: 12px; opacity: 0; transition: opacity 0.25s; pointer-events: none;
    }
    .other-messages .message-content::before {
      background: linear-gradient(135deg, rgba(0,0,0,0.04) 0%, transparent 60%);
    }
    .message:hover .message-content::before { opacity: 1; }
    .message-menu-btn {
      display: none; position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; background: transparent;
      border: none; cursor: pointer; align-items: center; justify-content: center; padding: 0;
      transition: opacity 0.25s, transform 0.25s; opacity: 0; transform: scale(0.85); z-index: 10;
    }
    .message-menu-btn svg { width: 14px; height: 14px; stroke: rgba(255,255,255,0.85); stroke-width: 2; fill: none; transition: all 0.2s; }
    .other-messages .message-menu-btn svg { stroke: rgba(0,0,0,0.6); }
    .message:hover .message-menu-btn { display: flex; opacity: 1; transform: scale(1); }
    .message-menu-btn:hover svg { transform: translateY(1px); stroke: rgba(255,255,255,1); }
    .other-messages .message-menu-btn:hover svg { stroke: rgba(0,0,0,0.8); }
    .message-dropdown {
      position: absolute; top: 100%; right: -5px; background: #fff; border: 1px solid var(--border); border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; display: none; min-width: 150px;
      margin-top: 0.5rem; opacity: 0; transform: translateY(-10px) scale(0.95); transition: opacity 0.3s, transform 0.3s;
    }
    .message-dropdown.active { display: block; opacity: 1; transform: translateY(0) scale(1); }
    .dropdown-item {
      padding: 0.75rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;
      text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); transition: background 0.2s;
    }
    .dropdown-item:last-child { border-bottom: none; }
    .dropdown-item:hover { background: var(--bg-alt); }
    .dropdown-item svg { width: 16px; height: 16px; }
    .dropdown-item.delete { color: #FF3B30; }
    .edited-badge { font-size: 0.7rem; color: rgba(255,255,255,0.7); font-style: italic; margin-left: 0.5rem; }
    .other-messages .edited-badge { color: var(--text-muted); }
    .message-image { max-width: 300px; max-height: 400px; border-radius: 8px; cursor: pointer; display: block; }
    .message-file {
      padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; display: flex; align-items: center; gap: 1rem; cursor: pointer;
    }
    .file-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.1); border-radius: 8px;}
    .file-icon svg { width: 24px; height: 24px; }
    .file-info { flex: 1; }
    .file-name { font-weight: 600; margin-bottom: 0.3rem; }
    .file-size { font-size: 0.8rem; opacity: 0.7; }
    .message-audio { width: 250px; }
    .system-message { text-align: center; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.5rem; }
    .typing-indicator { color: var(--text-muted); font-size: 0.85rem; padding: 0 2rem; text-transform: uppercase; letter-spacing: 0.05em; min-height: 1.5rem; }
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7);
      display: none; align-items: center; justify-content: center; z-index: 2000;
    }
    .modal-overlay.active { display: flex; }
    .modal { background: #fff; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);}
    .modal h3 { font-size: 1.5rem; text-transform: uppercase; margin-bottom: 1.5rem; }
    .modal textarea {
      width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 8px; font-family: inherit;
      font-size: 0.95rem; resize: vertical; min-height: 100px; margin-bottom: 1.5rem;
    }
    .modal textarea:focus { outline: none; border-color: var(--accent);}
    .modal-actions { display: flex; gap: 1rem; justify-content: flex-end; }
    .modal-btn { padding: 0.75rem 1.5rem; border: none; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;}
    .modal-btn-primary { background: var(--primary); color: #fff; }
    .modal-btn-primary:hover { background: var(--accent);}
    .modal-btn-secondary { background: transparent; border: 2px solid var(--border); color: var(--text);}
    .modal-btn-secondary:hover { border-color: var(--primary);}
    .delete-mode-bar {
      position: sticky; bottom: 0; left: 0; right: 0; padding: 1.5rem 2rem; background: #FF3B30; color: #fff; display: none;
      justify-content: space-between; align-items: center; border-top: 2px solid rgba(255,255,255,0.2); flex-shrink: 0; opacity: 0;
      transform: translateY(20px); transition: opacity 0.4s cubic-bezier(0.4,0,0.2,1), transform 0.4s cubic-bezier(0.4,0,0.2,1); z-index: 101;
    }
    .delete-mode-bar.active { display: flex; opacity: 1; transform: translateY(0);}
    .delete-mode-info { font-weight: 600; text-transform: uppercase; font-size: 0.85rem; }
    .delete-mode-actions { display: flex; gap: 1rem; }
    .delete-mode-btn {
      padding: 0.75rem 1.5rem; border: 2px solid #fff; background: transparent; color: #fff; font-weight: 600; text-transform: uppercase;
      font-size: 0.75rem; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;
    }
    .delete-mode-btn:hover { background: #fff; color: #FF3B30; }
    .delete-mode-btn svg { width: 16px; height: 16px; }
    .message-input-container {
      position: sticky; bottom: 0; left: 0; right: 0; padding: 1rem 2rem; background: #fff;
      border-top: 2px solid var(--border); flex-shrink: 0; opacity: 1; transform: translateY(0);
      transition: opacity 0.4s cubic-bezier(0.4,0,0.2,1), transform 0.4s cubic-bezier(0.4,0,0.2,1); z-index: 100;
    }
    .delete-mode-active .message-input-container { opacity: 0; transform: translateY(20px); pointer-events: none;}
    .input-wrapper { display: flex; gap: 1rem; align-items: center; }
    .input-actions { display: flex; gap: 0.5rem; align-items: center; }
    .input-btn {
      width: 40px; height: 40px; border: 2px solid var(--border); background: transparent;
      cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; padding: 0; flex-shrink: 0;
    }
    .input-btn svg { width: 20px; height: 20px; stroke: var(--text); transition: stroke 0.2s;}
    .input-btn:hover { border-color: var(--accent);}
    .input-btn:hover svg { stroke: var(--accent);}
    .input-btn.recording { background: #FF3B30; border-color: #FF3B30; animation: pulse 1.5s infinite;}
    .input-btn.recording svg { stroke: #fff; }
    @keyframes pulse { 0%, 100% {opacity: 1;} 50% {opacity: 0.6;} }
    .message-input {
      flex: 1; padding: 0.75rem 1rem; font-size: 0.95rem; background: #fff; border: 2px solid var(--border); color: var(--text);
      font-family: inherit; resize: none; height: 44px; min-height: 44px; max-height: 44px; line-height: 1.5; overflow-y: auto;
    }
    .message-input:focus { outline: none; border-color: var(--accent);}
    .btn-send {
      padding: 0 1.5rem; background: var(--primary); color: #fff; border: none; cursor: pointer; font-weight: 600; text-transform: uppercase;
      font-size: 0.85rem; letter-spacing: 0.05em; transition: background 0.2s; height: 44px; display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0;
    }
    .btn-send:hover { background: var(--accent);}
    .btn-send svg { width: 18px; height: 18px; }
    .btn-send-text { display: inline; }
    .file-preview {
      padding: 1rem 2rem; background: var(--bg-alt);
      border-top: 1px solid var(--border); display: none; align-items: center; gap: 1rem;
    }
    .file-preview.active { display: flex; }
    .preview-image { max-height: 100px; border-radius: 4px; }
    .preview-info { flex: 1; }
    .btn-remove {
      padding: 0.5rem 1rem; background: #FF3B30; color: #fff; border: none; cursor: pointer; font-size: 0.8rem; text-transform: uppercase;
      display: flex; align-items: center; gap: 0.5rem;
    }
    .btn-remove svg { width: 14px; height: 14px; }
    .notification-toast {
      visibility: hidden;
      position: fixed; top: 90px; right: 2rem; background: var(--primary); color: #fff; padding: 1rem 1.5rem;
      border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(400px); transition: transform 0.3s;
      z-index: 1001; max-width: 300px;
    }
    .notification-toast.show { transform: translateX(0); 
          visibility: visible;
                }
    .sidebar {
      width: 280px; background: var(--bg-alt); padding: 2rem; overflow-y: auto; flex-shrink: 0;
    }
    .sidebar h3 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.15em; margin-bottom: 1.5rem; color: var(--text-muted); font-weight: 600;}
    .online-users-list { list-style: none;}
.online-user {
  display: flex;
  align-items: center;      /* This centers items vertically */
  gap: 1.2rem;              /* Adjust gap between avatar and name as needed */
  padding: 0.8rem 1.2rem;
  background: #fff;
  box-shadow: none;
  border-left: 2px solid var(--primary);
}
    input[type="file"] { display: none; }
    .mobile-media-menu {
      position: fixed; bottom: 0; left: 0; right: 0; display: none; background: #fff;
      border-top: 2px solid var(--border); padding: 2rem; transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); z-index: 2000;
    }
    .mobile-media-menu.active { display: block; transform: translateY(0);}
    .mobile-media-menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
    .mobile-media-menu-title { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted);}
    .mobile-media-menu-close {
      width: 36px; height: 36px; border: 2px solid var(--border); background: transparent;
      display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s;
    }
    .mobile-media-menu-close:hover { border-color: var(--primary); background: var(--bg-alt); }
    .mobile-media-menu-close svg { width: 16px; height: 16px; stroke: var(--text);}
    .mobile-media-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;}
    .mobile-media-option {
      display: flex; flex-direction: column; align-items: center; gap: 1rem; padding: 1.5rem 1rem;
      background: transparent; border: 2px solid var(--border); cursor: pointer; transition: all 0.2s;
    }
    .mobile-media-option:active { transform: scale(0.97); border-color: var(--primary);}
    .mobile-media-option-icon { width: 48px; height: 48px; background: var(--primary); display: flex; align-items: center; justify-content: center;}
    .mobile-media-option-icon svg { width: 24px; height: 24px; stroke: #fff; stroke-width: 2;}
    .mobile-media-option-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; color: var(--text);}
    .mobile-menu-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 1999; display: none;}
    .mobile-menu-overlay.active { display: block; opacity: 1; pointer-events: all;}
    .mobile-attach-btn {
      display: none; width: 44px; height: 44px; border: 2px solid var(--border); background: transparent;
      cursor: pointer; align-items: center; justify-content: center; transition: all 0.2s; padding: 0; flex-shrink: 0;
    }
    .mobile-attach-btn svg { width: 20px; height: 20px; stroke: var(--text); transition: stroke 0.2s;}
    .mobile-attach-btn:hover { border-color: var(--accent);}
    .mobile-attach-btn:hover svg { stroke: var(--accent);}
    @media (max-width: 968px) {
      .chat-container { padding-top: 60px; }
      .header { padding: 1rem; }
      .header h1 { font-size: 1.2rem;}
      .chat-body { flex-direction: column;}
      .messages-section { border-right: none; border-bottom: 2px solid var(--border);}
      .sidebar { width: 100%; max-height: 200px;}
      .message { max-width: 85vw;}
      .notification-toast { right: 1rem; left: 1rem; max-width: none;}
      .delete-mode-bar { flex-direction: column; gap: 1rem; padding: 1rem;}
      .delete-mode-actions { width: 100%;}
      .delete-mode-btn { flex: 1;}
      .input-wrapper { gap: 0.5rem;}
      .input-actions { display: none;}
      .mobile-attach-btn { display: flex;}
      .message-input { flex: 1; min-width: 0; font-size: 0.9rem; padding: 0.75rem;}
      .btn-send { padding: 0; width: 44px; height: 44px; justify-content: center;}
      .btn-send-text { display: none;}
      .btn-send svg { width: 20px; height: 20px;}
      .message-input-container { padding: 0.75rem 1rem; }
    }
    @media (max-width: 480px) {
      .header h1 { font-size: 1rem;}
      .btn-back, .btn-settings { padding: 0.5rem 1rem; font-size: 0.7rem;
       }
         .btn-back .btn-text, 
  .btn-settings .btn-text {
    display: none; /* Hide text on mobile */
  }
 .settings-tab {
    padding: 0.9rem 1rem;
    font-size: 0.75rem; /* Even smaller font on very small screens */
  }

  .settings-modal {
    padding: 1.5rem; /* Less padding on very small screens */
  }

  .settings-modal h3 {
    font-size: 1.3rem; /* Slightly smaller title */
    margin-bottom: 1rem;
  }
      .message-input { font-size: 0.85rem;}
      .btn-send { width: 40px; height: 40px;}
      .mobile-attach-btn { width: 40px; height: 40px;}
      .mobile-media-options { gap: 1rem;}
      .mobile-media-option { padding: 1rem 0.5rem;}
      .mobile-media-option-icon { width: 40px; height: 40px;}
      .mobile-media-option-icon svg { width: 20px; height: 20px;}
    }
    ::-webkit-scrollbar { width: 8px; height: 8px;}
    ::-webkit-scrollbar-track { background: var(--bg-alt);}
    ::-webkit-scrollbar-thumb { background: var(--border);}
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted);}
    .avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  overflow: hidden;
  background: #ccc;
  font-weight: 700;
  font-size: 18px;
  color: #444;
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
}

/* Image Modal/Lightbox */
.image-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  padding-top: 50px;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.95);
  animation: fadeIn 0.3s;
}

.image-modal-content {
  margin: auto;
  display: block;
  max-width: 90%;
  max-height: 85vh;
  object-fit: contain;
  animation: zoomIn 0.3s;
}

.image-modal-close {
  position: absolute;
  top: 20px;
  right: 40px;
  color: #fff;
  font-size: 50px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
  z-index: 10000;
}

.image-modal-close:hover,
.image-modal-close:focus {
  color: #bbb;
}

.image-modal-caption {
  margin: auto;
  display: block;
  width: 80%;
  max-width: 700px;
  text-align: center;
  color: #ccc;
  padding: 10px 0;
  font-size: 16px;
}

@keyframes zoomIn {
  from {
    transform: scale(0.7);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Mobile responsive */
@media (max-width: 768px) {
  .image-modal-content {
    max-width: 95%;
    max-height: 80vh;
  }
  
  .image-modal-close {
    top: 10px;
    right: 20px;
    font-size: 40px;
  }
}

/* Settings Modal Styles */
/* Add these styles to fix the settings modal */
.settings-modal {
  max-width: 600px;
  width: 90%;
  max-height: 80vh; /* Limit maximum height */
  overflow: hidden; /* Prevent overflow */
  display: flex;
  flex-direction: column;
}

.settings-content {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.settings-sections {
  flex: 1;
  overflow-y: auto; /* Scroll if content is too long */
  padding-right: 0.5rem;
}

/* Tab navigation styles */
.settings-tabs {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--border);
  margin-bottom: 1.5rem;
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 10;
}

.settings-tab {
  padding: 1rem 1.5rem;
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-weight: 600;
  color: var(--text-muted);
  position: relative;
  transition: all 0.2s;
  white-space: nowrap;
}

.settings-tab:hover {
  color: var(--text);
  background: var(--bg-alt);
}

.settings-tab.active {
  color: var(--primary);
}

.settings-tab.active::after {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--primary);
  animation: underlineSlide 0.3s ease-out;
}

@keyframes underlineSlide {
  from {
    transform: scaleX(0);
    transform-origin: left;
  }
  to {
    transform: scaleX(1);
    transform-origin: left;
  }
}

/* Animation for content */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.media-content-section {
  animation: fadeIn 0.3s ease-in;
}

/* Update media grid heights to fit within modal */
.media-grid {
  max-height: 300px; /* Reduced from 400px */
}

.files-list, .audio-list {
  max-height: 300px; /* Reduced from 400px */
}
.settings-section {
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.settings-section h4 {
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 1rem;
  color: var(--text-muted);
}

.settings-options {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 1rem;
}

.settings-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  padding: 1rem;
  background: transparent;
  border: 2px solid var(--border);
  cursor: pointer;
  transition: all 0.2s;
}

.settings-option:hover {
  border-color: var(--primary);
}

.settings-option.active {
  border-color: var(--accent);
  background: rgba(0, 102, 255, 0.05);
}

.settings-option-icon {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-alt);
  border-radius: 8px;
}

.settings-option-icon svg {
  width: 20px;
  height: 20px;
  stroke: var(--text);
}

.settings-option-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-weight: 600;
}

.color-options {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.color-option {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
}

.color-option:hover {
  transform: scale(1.1);
}

.color-option.active {
  border-color: var(--primary);
  transform: scale(1.1);
}

/* Reply Preview Styles */
.reply-preview {
  display: none;
  padding: 0.75rem 1rem;
  background: var(--bg-alt);
  border-bottom: 1px solid var(--border);
  border-top: 1px solid var(--border);
  position: relative;
}

.reply-preview.active {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.reply-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.reply-author {
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
}

.reply-content {
  font-size: 0.85rem;
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.reply-close {
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 0.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.reply-close svg {
  width: 16px;
  height: 16px;
  stroke: var(--text-muted);
}

.reply-close:hover svg {
  stroke: var(--text);
}

/* Other User Message Dropdown */
.other-messages .message-menu-btn {
  display: none;
  position: absolute;
  top: 4px;
  right: 4px;
  width: 20px;
  height: 20px;
  background: transparent;
  border: none;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  padding: 0;
  transition: opacity 0.25s, transform 0.25s;
  opacity: 0;
  transform: scale(0.85);
  z-index: 10;
}

.other-messages .message:hover .message-menu-btn {
  display: flex;
  opacity: 1;
  transform: scale(1);
}

.other-messages .message-dropdown {
  position: absolute;
  top: 100%;
  right: -5px;
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  z-index: 100;
  display: none;
  min-width: 150px;
  margin-top: 0.5rem;
  opacity: 0;
  transform: translateY(-10px) scale(0.95);
  transition: opacity 0.3s, transform 0.3s;
}

.other-messages .message-dropdown.active {
  display: block;
  opacity: 1;
  transform: translateY(0) scale(1);
}

.other-messages .message-dropdown .dropdown-item {
  padding: 0.75rem 1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 1px solid var(--border);
  transition: background 0.2s;
}

.other-messages .message-dropdown .dropdown-item:last-child {
  border-bottom: none;
}

.other-messages .message-dropdown .dropdown-item:hover {
  background: var(--bg-alt);
}

.other-messages .message-dropdown .dropdown-item svg {
  width: 16px;
  height: 16px;
}

/* Arrow for other messages */
.other-messages .message-content::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: -8px;
  width: 0;
  height: 0;
  border-style: solid;
  border-width: 0 0 8px 8px;
  border-color: transparent transparent var(--other-message) transparent;
}

/* Reply Message Styles */
.reply-message {
  border-left: 3px solid var(--accent);
  padding: 0.5rem 0.75rem;
  margin-bottom: 0.75rem;
  background: rgba(0, 0, 0, 0.05);
  border-radius: 0 8px 8px 0;
}

.my-messages .reply-message {
  background: rgba(255, 255, 255, 0.2);
  border-left-color: rgba(255, 255, 255, 0.7);
}

.reply-meta {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.25rem;
}

.reply-author-name {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--accent);
}

.my-messages .reply-author-name {
  color: rgba(255, 255, 255, 0.9);
}

.reply-text {
  font-size: 0.85rem;
  opacity: 0.9;
}

.reply-indicator {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.my-messages .reply-indicator {
  color: rgba(255, 255, 255, 0.7);
}
/* Add these styles to your existing CSS */
.media-content-section {
  margin-bottom: 2rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.media-content-section h4 {
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 1rem;
  color: var(--text-muted);
}

.media-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 1rem;
  max-height: 300px;
  overflow-y: auto;
  padding: 0.5rem;
}

.media-item {
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s;
  aspect-ratio: 1;
}

.media-item:hover {
  transform: scale(1.05);
}

.media-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.files-list, .audio-list {
  max-height: 300px;
  overflow-y: auto;
  padding: 0.5rem;
}

.file-item, .audio-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-alt);
  border-radius: 8px;
  margin-bottom: 0.5rem;
  cursor: pointer;
  transition: background 0.2s;
}

.file-item:hover, .audio-item:hover {
  background: var(--border);
}

.file-icon, .audio-icon {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--primary);
  border-radius: 8px;
  flex-shrink: 0;
}

.file-icon svg, .audio-icon svg {
  width: 20px;
  height: 20px;
  stroke: #fff;
}

.file-info, .audio-info {
  flex: 1;
  min-width: 0;
}

.file-name, .audio-name {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 0.25rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.file-meta, .audio-meta {
  font-size: 0.8rem;
  color: var(--text-muted);
  display: flex;
  justify-content: space-between;
}

.no-media {
  text-align: center;
  padding: 2rem;
  color: var(--text-muted);
  font-style: italic;
}

.back-button {
  padding: 0.5rem 1rem;
  background: transparent;
  border: 2px solid var(--border);
  color: var(--text);
  cursor: pointer;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 1rem;
  transition: all 0.2s;
}

.back-button:hover {
  border-color: var(--primary);
}
  </style>
</head>

<body>
  <div class="notification-toast" id="notification-toast"></div>

  <div class="modal-overlay" id="edit-modal">
    <div class="modal">
      <h3>EDIT MESSAGE</h3>
      <textarea id="edit-textarea" placeholder="Edit your message..."></textarea>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-secondary" id="cancel-edit">CANCEL</button>
        <button class="modal-btn modal-btn-primary" id="save-edit">SAVE</button>
      </div>
    </div>
  </div>

<!-- Replace the existing settings modal with this updated version -->
<div class="modal-overlay" id="settings-modal">
  <div class="modal settings-modal">
    <h3>CHAT SETTINGS</h3>
    
    <div class="settings-content">
      <!-- Tab Navigation -->
      <div class="settings-tabs">
        <button class="settings-tab active" data-tab="appearance">APPEARANCE</button>
        <button class="settings-tab" data-tab="images">IMAGES</button>
        <button class="settings-tab" data-tab="files">FILES</button>
        <button class="settings-tab" data-tab="audio">AUDIO</button>
      </div>
      
      <div class="settings-sections">
        <!-- Appearance Section -->
        <div class="media-content-section" id="appearance-section">
          <div class="settings-section">
            <h4>BACKGROUND COLOR</h4>
            <div class="color-options">
              <div class="color-option active" style="background-color: #ffffff;" data-color="#ffffff"></div>
              <div class="color-option" style="background-color: #f8f8f8;" data-color="#f8f8f8"></div>
              <div class="color-option" style="background-color: #f0f0f0;" data-color="#f0f0f0"></div>
              <div class="color-option" style="background-color: #e8f4f8;" data-color="#e8f4f8"></div>
              <div class="color-option" style="background-color: #f8f0e8;" data-color="#f8f0e8"></div>
              <div class="color-option" style="background-color: #f0f8f0;" data-color="#f0f8f0"></div>
            </div>
          </div>
        </div>

        <!-- Images Section -->
        <div class="media-content-section" id="images-section" style="display: none;">
          <h4>SHARED IMAGES</h4>
          <div class="media-grid" id="images-grid">
            <!-- Images will be loaded here -->
          </div>
          <div class="no-media" id="no-images" style="display: none;">
            <p>No images shared in this chat yet.</p>
          </div>
        </div>

        <!-- Files Section -->
        <div class="media-content-section" id="files-section" style="display: none;">
          <h4>SHARED FILES</h4>
          <div class="files-list" id="files-list">
            <!-- Files will be loaded here -->
          </div>
          <div class="no-media" id="no-files" style="display: none;">
            <p>No files shared in this chat yet.</p>
          </div>
        </div>

        <!-- Audio Section -->
        <div class="media-content-section" id="audio-section" style="display: none;">
          <h4>VOICE MESSAGES</h4>
          <div class="audio-list" id="audio-list">
            <!-- Audio files will be loaded here -->
          </div>
          <div class="no-media" id="no-audio" style="display: none;">
            <p>No voice messages in this chat yet.</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal-actions">
      <button class="modal-btn modal-btn-secondary" id="close-settings">CLOSE</button>
    </div>
  </div>
</div>

  <div class="chat-container" id="chat-container">
<div class="header">
  <!-- Title on the left -->
  <h1 id="room-name">LOADING...</h1>
  <div id="encryption-status" class="encryption-status">Checking encryption...</div>

  <!-- Buttons on the right -->
  <div class="header-actions">
    <a class="btn-settings" id="settings-btn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
      <div class="btn-text">      
Settings
</div>   
 </a>
    <a href="/dashboard" class="btn-back">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
      <div class="btn-text">      
        BACK
</div>
    </a>
  </div>
</div>

    <div class="chat-body">
      <div class="messages-section">
        <div class="messages-container" id="messages"></div>
        <div class="typing-indicator" id="typing-indicator"></div>
        
        <div class="reply-preview" id="reply-preview">
          <div class="reply-info">
            <div class="reply-author" id="reply-author"></div>
            <div class="reply-content" id="reply-content"></div>
          </div>
          <button class="reply-close" id="reply-close">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
        
        <div class="file-preview" id="file-preview">
          <img class="preview-image" id="preview-image" style="display:none;">
          <div class="preview-info">
            <div id="preview-name"></div>
            <div id="preview-size" style="font-size: 0.85rem; color: var(--text-muted);"></div>
          </div>
          <button class="btn-remove" id="remove-file">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            REMOVE
          </button>
        </div>

        <div class="delete-mode-bar" id="delete-mode-bar">
          <div class="delete-mode-info">
            <span id="selected-count">0</span> MESSAGE<span id="plural-s">S</span> SELECTED
          </div>
          <div class="delete-mode-actions">
            <button class="delete-mode-btn" id="confirm-delete">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
              </svg>
              DELETE
            </button>
            <button class="delete-mode-btn" id="cancel-delete">CANCEL</button>
          </div>
        </div>

        <div class="message-input-container">
          <div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>

          <div class="mobile-media-menu" id="mobile-media-menu">
            <div class="mobile-media-menu-header">
              <div class="mobile-media-menu-title">Attach Media</div>
              <button class="mobile-media-menu-close" id="close-media-menu">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"/>
                  <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>
            </div>
            <div class="mobile-media-options">
              <div class="mobile-media-option" id="mobile-attach-file-option">
                <div class="mobile-media-option-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                  </svg>
                </div>
                <div class="mobile-media-option-label">File</div>
              </div>
              <div class="mobile-media-option" id="mobile-attach-image-option">
                <div class="mobile-media-option-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                    <circle cx="9" cy="9" r="2"/>
                    <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                  </svg>
                </div>
                <div class="mobile-media-option-label">Image</div>
              </div>
              <div class="mobile-media-option" id="mobile-voice-record-option">
                <div class="mobile-media-option-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" x2="12" y1="19" y2="22"/>
                  </svg>
                </div>
                <div class="mobile-media-option-label">Voice</div>
              </div>
            </div>
          </div>

          <div class="input-wrapper">
            <button class="mobile-attach-btn" id="mobile-attach-btn" title="Attach media">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
            </button>

            <div class="input-actions">
              <button class="input-btn" id="attach-file" title="Attach file">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
              </button>
              <button class="input-btn" id="attach-image" title="Send image">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
              </button>
              <button class="input-btn" id="voice-record" title="Voice message">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
              </button>
              <input type="file" id="file-input" accept="*/*">
              <input type="file" id="image-input" accept="image/*">
            </div>
            <textarea class="message-input" id="message-input" placeholder="TYPE YOUR MESSAGE..." rows="1"></textarea>
            <button class="btn-send" id="send-btn">
              <span class="btn-send-text">SEND</span>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" x2="11" y1="2" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="sidebar">
        <h3>ONLINE USERS</h3>
        <ul class="online-users-list" id="online-users"></ul>
      </div>
    </div>
  </div>

  <!-- Image Modal/Lightbox -->
<div id="image-modal" class="image-modal">
  <span class="image-modal-close">&times;</span>
  <img class="image-modal-content" id="modal-image">
  <div class="image-modal-caption" id="image-caption"></div>
</div>

<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<script>
  const API_URL = window.location.origin + '/api';
  const SOCKET_URL = window.location.origin;
  const token = localStorage.getItem('token');
  const anonName = localStorage.getItem('anonName');
  const currentRoom = localStorage.getItem('currentRoom');
  const currentRoomName = localStorage.getItem('currentRoomName');
  let myUserId = localStorage.getItem('userId');

  // --- E2EE CONFIG ---
let encryptionEnabled = false;
let roomKey = null; // CryptoKey for AES-GCM

function bufToBase64(buf) {
  const bytes = new Uint8Array(buf);
  let binary = '';
  for (let i = 0; i < bytes.byteLength; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary);
}

function base64ToBuf(b64) {
  const binary = atob(b64);
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) {
    bytes[i] = binary.charCodeAt(i);
  }
  return bytes.buffer;
}

async function deriveRoomKeyFromPassphrase(passphrase, roomId) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw',
    enc.encode(passphrase),
    'PBKDF2',
    false,
    ['deriveKey']
  );

  const key = await crypto.subtle.deriveKey(
    {
      name: 'PBKDF2',
      salt: enc.encode('UNMASK-' + roomId), // room-specific salt
      iterations: 100000,
      hash: 'SHA-256'
    },
    keyMaterial,
    {
      name: 'AES-GCM',
      length: 256
    },
    false,
    ['encrypt', 'decrypt']
  );

  return key;
}

async function encryptString(plain) {
  if (!roomKey) throw new Error('No room key set');
  const enc = new TextEncoder();
  const iv = crypto.getRandomValues(new Uint8Array(12));

  const ciphertext = await crypto.subtle.encrypt(
    { name: 'AES-GCM', iv },
    roomKey,
    enc.encode(plain)
  );

  return {
    iv: bufToBase64(iv.buffer),
    ciphertext: bufToBase64(ciphertext)
  };
}

async function decryptString(ciphertextB64, ivB64) {
  if (!roomKey) throw new Error('No room key set');
  const dec = new TextDecoder();
  const iv = new Uint8Array(base64ToBuf(ivB64));
  const ciphertext = base64ToBuf(ciphertextB64);

  const plainBuf = await crypto.subtle.decrypt(
    { name: 'AES-GCM', iv },
    roomKey,
    ciphertext
  );

  return dec.decode(plainBuf);
}

// Ask user for room passphrase (optional)
async function initEncryption() {
  if (!window.crypto || !window.crypto.subtle) {
    console.warn('Web Crypto not supported; E2EE disabled.');
    return;
  }

  const passphrase = window.prompt(
    'Optional: Enter a room secret for end-to-end encryption.\n' +
    'Everyone in this room must enter the same secret.\n' +
    'Leave blank to disable encryption.'
  );

  if (!passphrase) {
    encryptionEnabled = false;
    return;
  }

  try {
    roomKey = await deriveRoomKeyFromPassphrase(passphrase, currentRoom);
    encryptionEnabled = true;
    console.log('E2EE enabled for this room.');
  } catch (err) {
    console.error('Failed to derive room key:', err);
    encryptionEnabled = false;
  }
}


  // Image Modal Functions
const imageModal = document.getElementById('image-modal');
const modalImg = document.getElementById('modal-image');
const captionText = document.getElementById('image-caption');
const closeModal = document.querySelector('.image-modal-close');

function openImageModal(imageSrc, caption = '') {
  imageModal.style.display = 'block';
  modalImg.src = imageSrc;
  captionText.textContent = caption;
  document.body.style.overflow = 'hidden';
}

function closeImageModal() {
  imageModal.style.display = 'none';
  document.body.style.overflow = '';
}

if (closeModal) {
  closeModal.onclick = closeImageModal;
}

imageModal.onclick = function(e) {
  if (e.target === imageModal || e.target === closeModal) {
    closeImageModal();
  }
}

// Close on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && imageModal.style.display === 'block') {
    closeImageModal();
  }
});

  if (!token || !currentRoom) {
    window.location.href = '/dashboard';
  }

  document.getElementById('room-name').textContent = currentRoomName;

  const socket = io(SOCKET_URL, {
    auth: { token: token },
    maxHttpBufferSize: 1e8,
    pingTimeout: 60000
  });

  const messagesContainer = document.getElementById('messages');
  const messageInput = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const onlineUsersList = document.getElementById('online-users');
  const typingIndicator = document.getElementById('typing-indicator');
  const notificationToast = document.getElementById('notification-toast');
  const chatContainer = document.getElementById('chat-container');
  const deleteModeBar = document.getElementById('delete-mode-bar');
  const selectedCountEl = document.getElementById('selected-count');
  const editModal = document.getElementById('edit-modal');
  const editTextarea = document.getElementById('edit-textarea');
  const settingsModal = document.getElementById('settings-modal');
  const settingsBtn = document.getElementById('settings-btn');
  const closeSettingsBtn = document.getElementById('close-settings');
  const replyPreview = document.getElementById('reply-preview');
  const replyAuthor = document.getElementById('reply-author');
  const replyContent = document.getElementById('reply-content');
  const replyClose = document.getElementById('reply-close');

  let isDeleteMode = false;
  let selectedMessages = new Set();
  let currentEditMessageId = null;
  let selectedFile = null;
  let selectedFileType = 'file';
  let replyingTo = null;
  let replyMessageData = null;

  // Settings functionality
  settingsBtn.addEventListener('click', () => {
    settingsModal.classList.add('active');
  });

  closeSettingsBtn.addEventListener('click', () => {
    settingsModal.classList.remove('active');
  });

  settingsModal.addEventListener('click', (e) => {
    if (e.target === settingsModal) {
      settingsModal.classList.remove('active');
    }
  });

  // Background color selection
  document.querySelectorAll('.color-option').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('active');
      });
      option.classList.add('active');
      
      const color = option.getAttribute('data-color');
      document.body.style.backgroundColor = color;
      localStorage.setItem('chatBackgroundColor', color);
    });
  });

  // Load saved background color
  const savedColor = localStorage.getItem('chatBackgroundColor');
  if (savedColor) {
    document.body.style.backgroundColor = savedColor;
    document.querySelectorAll('.color-option').forEach(option => {
      if (option.getAttribute('data-color') === savedColor) {
        option.classList.add('active');
      } else {
        option.classList.remove('active');
      }
    });
  }

  // Settings options
// Tab functionality for settings
let currentTab = 'appearance';

document.querySelectorAll('.settings-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const tabName = tab.getAttribute('data-tab');
    
    // Update active tab
    document.querySelectorAll('.settings-tab').forEach(t => {
      t.classList.remove('active');
    });
    tab.classList.add('active');
    
    // Hide all sections
    document.querySelectorAll('.media-content-section').forEach(section => {
      section.style.display = 'none';
    });
    
    // Show selected section
    document.getElementById(`${tabName}-section`).style.display = 'block';
    currentTab = tabName;
    
    // Load content if needed
    if (tabName === 'images') {
      loadImages();
    } else if (tabName === 'files') {
      loadFiles();
    } else if (tabName === 'audio') {
      loadAudio();
    }
  });
});

// Update the load functions to handle the tab interface
async function loadImages() {
  try {
const messages = await fetchRoomMessages();
const images = messages.filter(msg => msg.messageType === 'image');
    
    const imagesGrid = document.getElementById('images-grid');
    const noImages = document.getElementById('no-images');
    
    imagesGrid.innerHTML = '';
    
    if (images.length === 0) {
      noImages.style.display = 'block';
      imagesGrid.style.display = 'none';
    } else {
      noImages.style.display = 'none';
      imagesGrid.style.display = 'grid';
      
      images.forEach(image => {
        const mediaItem = document.createElement('div');
        mediaItem.className = 'media-item';
        mediaItem.innerHTML = `
          <img src="${image.message}" alt="Shared image" onclick="openImageModal('${image.message}', 'Image from ${escapeHtml(image.senderAnonName)}')">
        `;
        imagesGrid.appendChild(mediaItem);
      });
    }
    
  } catch (error) {
    console.error('Error loading images:', error);
    document.getElementById('no-images').style.display = 'block';
    document.getElementById('images-grid').style.display = 'none';
  }
}

async function loadFiles() {
  try {
    const messages = await fetchRoomMessages();
    const files = messages.filter(msg => msg.messageType === 'file');

    
    const filesList = document.getElementById('files-list');
    const noFiles = document.getElementById('no-files');
    
    filesList.innerHTML = '';
    
    if (files.length === 0) {
      noFiles.style.display = 'block';
      filesList.style.display = 'none';
    } else {
      noFiles.style.display = 'none';
      filesList.style.display = 'block';
      
      files.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.onclick = () => downloadFile(file.message, file.fileName);
        fileItem.innerHTML = `
          <div class="file-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
              <polyline points="14 2 14 8 20 8"/>
            </svg>
          </div>
          <div class="file-info">
            <div class="file-name">${escapeHtml(file.fileName)}</div>
            <div class="file-meta">
              <span>From: ${escapeHtml(file.senderAnonName)}</span>
              <span>${formatFileSize(file.fileSize || 0)}</span>
            </div>
          </div>
        `;
        filesList.appendChild(fileItem);
      });
    }
    
  } catch (error) {
    console.error('Error loading files:', error);
    document.getElementById('no-files').style.display = 'block';
    document.getElementById('files-list').style.display = 'none';
  }
}

async function loadAudio() {
  try {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelector('.tab[onclick*="audio"]').classList.add('active');
    
    const audioList = document.getElementById('audio-list');
    const noAudio = document.getElementById('no-audio');
    
    audioList.innerHTML = '';
    
    if (audioMessages.length === 0) {
      noAudio.style.display = 'block';
      audioList.style.display = 'none';
    } else {
      noAudio.style.display = 'none';
      audioList.style.display = 'block';
      
      audioMessages.forEach(audio => {
        const audioItem = document.createElement('div');
        audioItem.className = 'audio-item';
        audioItem.innerHTML = `
          <div class="audio-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
              <line x1="12" x2="12" y1="19" y2="22"/>
            </svg>
          </div>
          <div class="audio-info">
            <div class="audio-name">Voice Message</div>
            <div class="audio-meta">
              <span>From: ${escapeHtml(audio.senderAnonName)}</span>
              <span>${new Date(audio.timestamp).toLocaleDateString()}</span>
            </div>
          </div>
          <audio controls style="width: 150px; height: 40px;">
            <source src="${audio.message}" type="audio/webm">
            Your browser does not support the audio element.
          </audio>
        `;
        audioList.appendChild(audioItem);
      });
    }
    
  } catch (error) {
    console.error('Error loading audio:', error);
    document.getElementById('no-audio').style.display = 'block';
    document.getElementById('audio-list').style.display = 'none';
  }
}

// Reset to appearance tab when closing settings
document.getElementById('close-settings').addEventListener('click', () => {
  settingsModal.classList.remove('active');
  // Reset to appearance tab
  document.querySelectorAll('.settings-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelector('[data-tab="appearance"]').classList.add('active');
  
  document.querySelectorAll('.media-content-section').forEach(section => {
    section.style.display = 'none';
  });
  document.getElementById('appearance-section').style.display = 'block';
});
// Also hide media sections when clicking outside the modal
settingsModal.addEventListener('click', (e) => {
  if (e.target === settingsModal) {
    settingsModal.classList.remove('active');
    document.querySelectorAll('.media-content-section').forEach(section => {
      section.style.display = 'none';
    });
  }
});

  // Reply functionality
  replyClose.addEventListener('click', () => {
    replyPreview.classList.remove('active');
    replyingTo = null;
    replyMessageData = null;
  });

  function setReply(messageId, author, content, messageData) {
    replyingTo = messageId;
    replyMessageData = messageData;
    replyAuthor.textContent = author;
    replyContent.textContent = content;
    replyPreview.classList.add('active');
    messageInput.focus();
  }

  const mobileAttachBtn = document.getElementById('mobile-attach-btn');
  const mobileMediaMenu = document.getElementById('mobile-media-menu');
  const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
  const closeMediaMenu = document.getElementById('close-media-menu');

  function openMobileMediaMenu() {
    mobileMediaMenu.classList.add('active');
    mobileMenuOverlay.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeMobileMediaMenu() {
    mobileMediaMenu.classList.remove('active');
    mobileMenuOverlay.classList.remove('active');
    document.body.style.overflow = '';
  }

  if (mobileAttachBtn) {
    mobileAttachBtn.addEventListener('click', openMobileMediaMenu);
  }

  if (closeMediaMenu) {
    closeMediaMenu.addEventListener('click', (e) => {
      e.preventDefault();
      closeMobileMediaMenu();
    });
  }

  if (mobileMenuOverlay) {
    mobileMenuOverlay.addEventListener('click', closeMobileMediaMenu);
  }

  document.getElementById('mobile-attach-file-option')?.addEventListener('click', () => {
    closeMobileMediaMenu();
    document.getElementById('file-input').click();
  });

  document.getElementById('mobile-attach-image-option')?.addEventListener('click', () => {
    closeMobileMediaMenu();
    document.getElementById('image-input').click();
  });

  document.getElementById('mobile-voice-record-option')?.addEventListener('click', () => {
    closeMobileMediaMenu();
    toggleVoiceRecording();
  });

  document.getElementById('attach-file').addEventListener('click', () => {
    document.getElementById('file-input').click();
  });

  document.getElementById('attach-image').addEventListener('click', () => {
    document.getElementById('image-input').click();
  });

  document.getElementById('file-input').addEventListener('change', (e) => {
    handleFileSelect(e.target.files[0], 'file');
  });

  document.getElementById('image-input').addEventListener('change', (e) => {
    handleFileSelect(e.target.files[0], 'image');
  });

  document.getElementById('remove-file').addEventListener('click', () => {
    selectedFile = null;
    document.getElementById('file-preview').classList.remove('active');
    document.getElementById('file-input').value = '';
    document.getElementById('image-input').value = '';
  });

  function handleFileSelect(file, type) {
    if (!file) return;
    
    if (file.size > 10 * 1024 * 1024) {
      alert('File size must be less than 10MB');
      return;
    }

    selectedFileType = type;
    const reader = new FileReader();
    
    reader.onload = (e) => {
      if (type === 'image') {
        compressImage(e.target.result, file.name, (compressedData) => {
          selectedFile = {
            data: compressedData,
            name: file.name,
            size: compressedData.length,
            type: file.type
          };
          showPreview(compressedData, file.name, compressedData.length);
        });
      } else {
        selectedFile = {
          data: e.target.result,
          name: file.name,
          size: file.size,
          type: file.type
        };
        showPreview(e.target.result, file.name, file.size);
      }
    };

    reader.readAsDataURL(file);
  }

  function compressImage(base64, fileName, callback) {
    const img = new Image();
    img.src = base64;
    
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let width = img.width;
      let height = img.height;
      
      const maxWidth = 1920;
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      const compressed = canvas.toDataURL('image/jpeg', 0.8);
      callback(compressed);
    };
  }

  function showPreview(data, name, size) {
    document.getElementById('preview-name').textContent = name;
    document.getElementById('preview-size').textContent = formatFileSize(size);
    
    if (selectedFileType === 'image') {
      document.getElementById('preview-image').src = data;
      document.getElementById('preview-image').style.display = 'block';
    } else {
      document.getElementById('preview-image').style.display = 'none';
    }
    
    document.getElementById('file-preview').classList.add('active');
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  let mediaRecorder;
  let audioChunks = [];
  let isRecording = false;

  document.getElementById('voice-record').addEventListener('click', toggleVoiceRecording);

  async function toggleVoiceRecording() {
    const btn = document.getElementById('voice-record');
    
    if (!isRecording) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const reader = new FileReader();
          reader.onload = (e) => {
            sendMessage(e.target.result, 'audio', 'voice-message.webm', audioBlob.size);
          };
          reader.readAsDataURL(audioBlob);
          
          stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        isRecording = true;
        btn.classList.add('recording');
        btn.title = 'Stop recording';
      } catch (error) {
        alert('Could not access microphone: ' + error.message);
      }
    } else {
      mediaRecorder.stop();
      isRecording = false;
      btn.classList.remove('recording');
      btn.title = 'Voice message';
    }
  }

function enterDeleteMode() {
  isDeleteMode = true;
  selectedMessages.clear();
  chatContainer.classList.add('delete-mode-active');
  deleteModeBar.classList.add('active');
  updateSelectedCount();
  closeAllDropdowns(); // This already exists
  
  // Force hide all menu buttons and dropdowns
  document.querySelectorAll('.message-menu-btn').forEach(btn => {
    btn.style.display = 'none';
  });
  
  document.querySelectorAll('.message-dropdown').forEach(dropdown => {
    dropdown.classList.remove('active');
    dropdown.style.display = 'none';
  });
}

function exitDeleteMode() {
  isDeleteMode = false;
  selectedMessages.clear();
  chatContainer.classList.remove('delete-mode-active');
  deleteModeBar.classList.remove('active');
  
  document.querySelectorAll('.message-checkbox').forEach(cb => {
    cb.checked = false;
  });
  
  // Restore menu buttons visibility
  document.querySelectorAll('.message-menu-btn').forEach(btn => {
    btn.style.display = '';
  });
  
  document.querySelectorAll('.message-dropdown').forEach(dropdown => {
    dropdown.style.display = '';
  });
}


  function updateSelectedCount() {
    const count = selectedMessages.size;
    selectedCountEl.textContent = count;
    
    const pluralS = document.getElementById('plural-s');
    if (pluralS) {
      pluralS.style.display = count === 1 ? 'none' : 'inline';
    }
  }

  function canEditMessage(timestamp) {
    const now = Date.now();
    const messageTime = new Date(timestamp).getTime();
    const timeDiff = now - messageTime;
    const tenMinutes = 10 * 60 * 1000;
    return timeDiff <= tenMinutes;
  }

  function openEditModal(messageId, currentText, timestamp) {
    if (!canEditMessage(timestamp)) {
      alert('Cannot edit message after 10 minutes');
      return;
    }

    currentEditMessageId = messageId;
    editTextarea.value = currentText;
    editModal.classList.add('active');
    editTextarea.focus();
  }

  function closeEditModal() {
    editModal.classList.remove('active');
    currentEditMessageId = null;
    editTextarea.value = '';
  }

  function saveEdit() {
    const newText = editTextarea.value.trim();
    if (!newText || !currentEditMessageId) return;

    socket.emit('editMessage', {
      messageId: currentEditMessageId,
      newText: newText,
      room: currentRoom
    });

    closeEditModal();
  }

  document.getElementById('cancel-edit').addEventListener('click', closeEditModal);
  document.getElementById('save-edit').addEventListener('click', saveEdit);

  editModal.addEventListener('click', (e) => {
    if (e.target === editModal) {
      closeEditModal();
    }
  });

  document.getElementById('cancel-delete').addEventListener('click', exitDeleteMode);

  document.getElementById('confirm-delete').addEventListener('click', () => {
    if (selectedMessages.size === 0) {
      alert('No messages selected');
      return;
    }

    if (confirm(`Delete ${selectedMessages.size} message(s)?`)) {
      socket.emit('deleteMessages', {
        messageIds: Array.from(selectedMessages),
        room: currentRoom
      });
      exitDeleteMode();
    }
  });

  function closeAllDropdowns() {
    document.querySelectorAll('.message-dropdown').forEach(dropdown => {
      dropdown.classList.remove('active');
    });
  }

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.message-menu-btn') && !e.target.closest('.message-dropdown')) {
      closeAllDropdowns();
    }
  });
async function fetchRoomMessages() {
  const response = await fetch(`${API_URL}/chat/messages/${currentRoom}`, {
    headers: { 'Authorization': `Bearer ${token}` }
  });

  const data = await response.json();
  const messages = data.messages || [];

  if (!encryptionEnabled || !roomKey) {
    return messages;
  }

  // Decrypt messages that have iv
  for (const msg of messages) {
    if (msg.iv && typeof msg.message === 'string') {
      try {
        msg.message = await decryptString(msg.message, msg.iv);
      } catch (err) {
        console.warn('Failed to decrypt message', msg._id, err);
        // leave ciphertext as-is (will look like gibberish)
      }
    }
  }

  return messages;
}

async function loadChatHistory() {
  try {
    const messages = await fetchRoomMessages();
    displayMessages(messages);
    scrollToBottom();
  } catch (error) {
    console.error('Error loading chat history:', error);
  }
}


  function displayMessages(messages) {
    messagesContainer.innerHTML = '';
    let currentGroup = null;
    let lastUserId = null;
    let lastTimestamp = null;

    messages.forEach((msg) => {
      const msgUserId = msg.senderUserId;
      const msgTime = new Date(msg.timestamp).getTime();
      const timeDiff = lastTimestamp ? msgTime - lastTimestamp : 0;

      if (msgUserId !== lastUserId || timeDiff > 60000) {
        currentGroup = createMessageGroup(msgUserId, msg.senderAnonName, null);
        messagesContainer.appendChild(currentGroup);
      }

      appendMessageToGroup(currentGroup, msg);
      lastUserId = msgUserId;
      lastTimestamp = msgTime;
    });
  }

function createMessageGroup(userId, authorName, profileImage) {
  const group = document.createElement('div');
  group.className = 'message-group ' + (userId === myUserId ? 'my-messages' : 'other-messages');
  group.dataset.userId = userId;
  
  const author = document.createElement('div');
  author.className = 'message-author';
  author.textContent = authorName;
  group.appendChild(author);

  return group;
}

  function appendMessageToGroup(group, msg) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message';
    messageDiv.dataset.messageId = msg._id;
    messageDiv.dataset.timestamp = msg.timestamp;

    if (msg.senderUserId === myUserId) {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'message-checkbox';
      checkbox.dataset.messageId = msg._id;
      checkbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          selectedMessages.add(msg._id);
        } else {
          selectedMessages.delete(msg._id);
        }
        updateSelectedCount();
      });
      messageDiv.appendChild(checkbox);
    }

    const content = document.createElement('div');
    content.className = 'message-content';

    // Add reply preview if this message is a reply
    if (msg.replyTo) {
      const replyIndicator = document.createElement('div');
      replyIndicator.className = 'reply-indicator';
      replyIndicator.textContent = 'Replying to:';
      content.appendChild(replyIndicator);

      const replyMessage = document.createElement('div');
      replyMessage.className = 'reply-message';
      
      const replyMeta = document.createElement('div');
      replyMeta.className = 'reply-meta';
      
      const replyAuthorName = document.createElement('div');
      replyAuthorName.className = 'reply-author-name';
      replyAuthorName.textContent = msg.replyTo.senderAnonName || 'Unknown';
      
      const replyText = document.createElement('div');
      replyText.className = 'reply-text';
      replyText.textContent = msg.replyTo.message;
      
      replyMeta.appendChild(replyAuthorName);
      replyMessage.appendChild(replyMeta);
      replyMessage.appendChild(replyText);
      content.appendChild(replyMessage);
    }

    if (msg.messageType === 'image') {
      const img = document.createElement('img');
      img.src = msg.message;
      img.className = 'message-image';
      img.onclick = () => openImageModal(msg.message, 'Image from ' + (msg.senderAnonName || 'chat'));
      content.appendChild(img);
    } else if (msg.messageType === 'audio') {
      const audio = document.createElement('audio');
      audio.src = msg.message;
      audio.controls = true;
      audio.className = 'message-audio';
      content.appendChild(audio);
    } else if (msg.messageType === 'file') {
      const fileDiv = document.createElement('div');
      fileDiv.className = 'message-file';
      fileDiv.innerHTML = `
        <div class="file-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
        </div>
        <div class="file-info">
          <div class="file-name">${escapeHtml(msg.fileName)}</div>
          <div class="file-size">${formatFileSize(msg.fileSize || 0)}</div>
        </div>
      `;
      fileDiv.onclick = () => downloadFile(msg.message, msg.fileName);
      content.appendChild(fileDiv);
    } else {
      const textNode = document.createTextNode(msg.message);
      content.appendChild(textNode);
      
      if (msg.isEdited) {
        const editedBadge = document.createElement('span');
        editedBadge.className = 'edited-badge';
        editedBadge.textContent = '(edited)';
        content.appendChild(editedBadge);
      }
    }

    messageDiv.appendChild(content);

    // Add menu button for all messages (both my and other messages)
    const menuBtn = document.createElement('button');
    menuBtn.className = 'message-menu-btn';
    menuBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"/>
      </svg>
    `;
    
    const dropdown = document.createElement('div');
    dropdown.className = 'message-dropdown';
    
    if (msg.senderUserId === myUserId && msg.messageType === 'text') {
      // My messages - edit and delete options
      dropdown.innerHTML = `
        <div class="dropdown-item" data-action="edit">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
          EDIT
        </div>
        <div class="dropdown-item delete" data-action="delete">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
          DELETE
        </div>
      `;
    } else {
      // Other messages - reply and copy options
      dropdown.innerHTML = `
        <div class="dropdown-item" data-action="reply">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 10 4 15 9 20"/><path d="M20 4v7a4 4 0 0 1-4 4H4"/></svg>
          REPLY
        </div>
        <div class="dropdown-item" data-action="copy">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
          COPY
        </div>
      `;
    }
    
    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      closeAllDropdowns();
      dropdown.classList.toggle('active');
    });

    dropdown.addEventListener('click', (e) => {
      const action = e.target.closest('.dropdown-item')?.dataset.action;
      if (action === 'edit') {
        openEditModal(msg._id, msg.message, msg.timestamp);
      } else if (action === 'delete') {
        enterDeleteMode();
      } else if (action === 'reply') {
        setReply(msg._id, msg.senderAnonName, msg.message, {
          messageId: msg._id,
          senderAnonName: msg.senderAnonName,
          message: msg.message,
          timestamp: msg.timestamp
        });
      } else if (action === 'copy') {
        navigator.clipboard.writeText(msg.message)
          .then(() => showNotification('Message copied to clipboard'))
          .catch(err => console.error('Failed to copy text: ', err));
      }
      dropdown.classList.remove('active');
    });

    messageDiv.appendChild(menuBtn);
    messageDiv.appendChild(dropdown);

    group.appendChild(messageDiv);
  }

  function downloadFile(dataUrl, fileName) {
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = fileName;
    a.click();
  }

  socket.on('connect', () => {
    console.log('Connected to server');
    socket.emit('joinRoom', { room: currentRoom });
  });

socket.on('message', async (data) => {
  // If encryption is enabled and message includes iv, try to decrypt
  if (encryptionEnabled && data.iv && typeof data.message === 'string') {
    try {
      data.message = await decryptString(data.message, data.iv);
    } catch (err) {
      console.warn('Failed to decrypt live message', data.messageId, err);
    }
  }

  addNewMessage(data);
  scrollToBottom();
  updateEncryptionUI();
});


  function addNewMessage(data) {
    const lastGroup = messagesContainer.lastElementChild;
    const lastGroupUserId = lastGroup ? lastGroup.dataset.userId : null;
    const timeDiff = lastGroup ? Date.now() - parseInt(lastGroup.dataset.lastTime || 0) : Infinity;

    if (lastGroupUserId === data.userId && timeDiff < 60000) {
      appendMessageToGroup(lastGroup, {
        _id: data.messageId || Date.now(),
        senderUserId: data.userId,
        messageType: data.messageType,
        message: data.message,
        fileName: data.fileName,
        fileSize: data.fileSize,
        timestamp: data.timestamp,
        isEdited: false,
        replyTo: data.replyTo
      });
      lastGroup.dataset.lastTime = new Date(data.timestamp).getTime();
    } else {
      const newGroup = createMessageGroup(data.userId, data.anonName, data.profileImage);
      newGroup.dataset.lastTime = new Date(data.timestamp).getTime();
      appendMessageToGroup(newGroup, {
        _id: data.messageId || Date.now(),
        senderUserId: data.userId,
        messageType: data.messageType,
        message: data.message,
        fileName: data.fileName,
        fileSize: data.fileSize,
        timestamp: data.timestamp,
        isEdited: false,
        replyTo: data.replyTo
      });
      messagesContainer.appendChild(newGroup);
    }
  }

  socket.on('messageEdited', (data) => {
    const messageEl = document.querySelector(`[data-message-id="${data.messageId}"]`);
    if (messageEl) {
      const content = messageEl.querySelector('.message-content');
      content.childNodes[0].textContent = data.newText;
      
      let editedBadge = content.querySelector('.edited-badge');
      if (!editedBadge) {
        editedBadge = document.createElement('span');
        editedBadge.className = 'edited-badge';
        editedBadge.textContent = '(edited)';
        content.appendChild(editedBadge);
      }
    }
  });

  socket.on('messagesDeleted', (data) => {
    data.messageIds.forEach(msgId => {
      const messageEl = document.querySelector(`[data-message-id="${msgId}"]`);
      if (messageEl) {
        const group = messageEl.closest('.message-group');
        messageEl.remove();
        
        if (group && group.children.length <= 1) {
          group.remove();
        }
      }
    });
  });

  socket.on('notification', (data) => {
    showNotification(data.message);
  });

  socket.on('userJoined', (data) => {
    appendSystemMessage(data.message);
    scrollToBottom();
  });

  socket.on('userLeft', (data) => {
    appendSystemMessage(data.message);
    scrollToBottom();
  });

  socket.on('onlineUsers', (users) => {
    renderOnlineUsers(users);
  });

  function renderOnlineUsers(users) {
    if (!onlineUsersList) return;
    
    onlineUsersList.innerHTML = users.map(user => {
      if (user.profileImage) {
        return `
          <li class="online-user">
            <img src="${user.profileImage}" alt="${escapeHtml(user.anonName)}" class="online-user-avatar" style="width:32px; height:32px; border-radius:50%; object-fit:cover; margin-right:0.7em;" />
            <span>${escapeHtml(user.anonName)}</span>
          </li>
        `;
      } else {
        const initial = user.anonName.charAt(0).toUpperCase();
        return `
          <li class="online-user">
            <div class="online-user-avatar-fallback" style="width:32px; height:32px; border-radius:50%; background:#ccc; color:#444; font-weight:700; font-size:18px; display:flex; align-items:center; justify-content:center; margin-right:0.7em;">${initial}</div>
            <span>${escapeHtml(user.anonName)}</span>
          </li>
        `;
      }
    }).join('');
  }

  let typingTimeout;
  socket.on('typing', (data) => {
    typingIndicator.textContent = `${data.anonName} IS TYPING...`;
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
      typingIndicator.textContent = '';
    }, 3000);
  });

  socket.on('stopTyping', () => {
    typingIndicator.textContent = '';
  });

  socket.on('error', (data) => {
    alert(data.message);
  });

async function sendMessage(data = null, type = 'text', fileName = null, fileSize = null) {
  let messageData;

  if (data) {
    messageData = data;
  } else if (selectedFile) {
    messageData = selectedFile.data;
    type = selectedFileType;
    fileName = selectedFile.name;
    fileSize = selectedFile.size;
  } else {
    const text = messageInput.value.trim();
    if (!text) return;
    messageData = text;
  }

  let payloadText = messageData;
  let iv = null;

  if (encryptionEnabled && roomKey) {
    try {
      const encrypted = await encryptString(String(messageData));
      payloadText = encrypted.ciphertext;
      iv = encrypted.iv;
    } catch (err) {
      console.error('Failed to encrypt message, sending plaintext fallback:', err);
      // if you want, you can `return` here instead of falling back
    }
  }

  const messagePayload = { 
    room: currentRoom, 
    text: payloadText,
    type: type,
    fileName: fileName,
    fileSize: fileSize,
    iv: iv
  };

  if (replyingTo && replyMessageData) {
    messagePayload.replyTo = replyMessageData;
  }

  socket.emit('message', messagePayload);

  messageInput.value = '';
  selectedFile = null;
  document.getElementById('file-preview').classList.remove('active');
  document.getElementById('file-input').value = '';
  document.getElementById('image-input').value = '';
  
  replyPreview.classList.remove('active');
  replyingTo = null;
  replyMessageData = null;
  
  socket.emit('stopTyping', { room: currentRoom });
}


  sendBtn.addEventListener('click', () => sendMessage());
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  let typingTimer;
  messageInput.addEventListener('input', () => {
    socket.emit('typing', { room: currentRoom });
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
      socket.emit('stopTyping', { room: currentRoom });
    }, 1000);
  });

  function appendSystemMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'system-message';
    messageDiv.textContent = message;
    messagesContainer.appendChild(messageDiv);
  }

  function showNotification(message) {
    notificationToast.textContent = message;
    notificationToast.classList.add('show');
    setTimeout(() => {
      notificationToast.classList.remove('show');
    }, 3000);
  }

  function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function fetchUserId() {
    try {
      const response = await fetch(`${API_URL}/auth/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await response.json();
      myUserId = data.userId;
      localStorage.setItem('userId', data.userId);
    } catch (error) {
      console.error('Error fetching user ID:', error);
    }
  }

  function updateEncryptionUI() {
  const el = document.getElementById('encryption-status');
  if (!el) return;

  if (encryptionEnabled && roomKey) {
    el.textContent = "Encrypted ";
    el.classList.add("encryption-on");
    el.classList.remove("encryption-off");
  } else {
    el.textContent = "Not Encrypted ";
    el.classList.add("encryption-off");
    el.classList.remove("encryption-on");
  }
}


(async () => {
await initEncryption();
updateEncryptionUI();
await fetchUserId();
await loadChatHistory();
updateEncryptionUI(); // ensure state after history loaded
})();



  window.addEventListener('beforeunload', () => {
    socket.emit('leaveRoom', { room: currentRoom });
  });
</script>

</body>
</html>